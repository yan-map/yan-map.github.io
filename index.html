<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<meta name="theme-color" content="#ff5575">
<title>Карта МЦД</title>
<link rel="shortcut icon" href="data/favicon.gif" />
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.css' type='text/css' />
<style>
body { margin:0; padding:0; }
#map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
 <style>
.geocoder {
	position:absolute;
  width: 98%;
	left: 2%;
	top: 13px;
} 
.mapboxgl-ctrl-geocoder{
font-family: 'Ubuntu Mono', monospace;
border-radius: 24px;
width: 98%;
}

#menu {
display: button;
position: absolute;
z-index: 1;
bottom: 20px; 
right: 7px;
font-family: 'Ubuntu Mono', monospace;
font-weight: bold;
}
 
#menu a {
background: #fff;
margin-right: 3px;
font-size: 14px;
color: #777;
border-radius: 24px;
padding: 10px;
text-decoration: none;
border-top: 3px solid rgba(0,0,0,0.25);
text-align: center;
}
  
#menu a:hover {
background-color: #cfcfcf;
border-radius: 24px;
color: #777;
}
 
#menu a.active {
background-color: #ff5575;
border-radius: 24px;
color: #ffffff;
border-bottom: 3px solid rgba(0,0,0,0.25);
border-top: none;
}
 
#menu a.active:hover {
border-radius: 24px;
background: #be2e4b;
border-bottom: 3px solid rgba(0,0,0,0.15);
}
</style>
 
<nav id="menu"></nav>
<div id="map"></div>
<div id='geocoder' class='geocoder'></div>
 
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoieWFucG9ndXRzYSIsImEiOiJjajBhMzJydzIwZmtmMndvY3ozejFicTdqIn0.T6DCFk1BSoEkdG-2agIoQQ';
var map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/yanpogutsa/cjzbf944b07bh1dqwjgbdjp8u',
attributionControl: false,
center: [37.618, 55.751],
minZoom: 2,
zoom: 10,
bearingSnap: 30,
doubleClickZoom: false,
antialias: true,
maxBounds: [
[36.5401693241436050, 55.0203058196276160], // Southwest coordinates
[38.3135420226066969, 56.1505434064830737]  // Northeast coordinates
]
});

map.on('load', function() {

map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 15,
        'paint': {
            'fill-extrusion-color': '#cac7d1',

            // use an 'interpolate' expression to add a smooth transition effect to the
            // buildings as the user zooms in
            'fill-extrusion-height': ["get", "height"],
            'fill-extrusion-base': ["get", "min_height"],
            'fill-extrusion-opacity': .6
        },
				'layout': {
					'visibility': 'none',
				}
    },'housenum-label');

map.addLayer ({
	"id":"ped_bridges_mcd",
	"type": "fill",
	"source":{
		"type": "geojson",
		"data": "./data/ped.json"
	},
	"paint":{
	"fill-color": "#3abb8c",
	"fill-outline-color": "#26976d",
	"fill-opacity":0.7},
});


map.addLayer({
"id": "ДКР",
"type": "line",
"source": {
type: 'vector',
url: 'mapbox://yanpogutsa.0p9ye6kw'
},
"source-layer": "l_blag-a9ug8y",
"filter": [
  "all",
  [
    "match",
    ["get", "Year"],
    [9999],
    false,
    true
  ]
],
"layout": {
"visibility": "none",
"line-cap": "butt",
"line-join": "round",
},
"paint": {
"line-opacity": 0.5,
"line-color": [
  "case",
  [
    ">=",
    ["get", "Year"],
    2019
  ],
  "#3cbe66",
  "hsl(324, 16%, 34%)"
],
"line-width": [
  "interpolate",
  ["linear"],
  ["zoom"],
  11,
  2,
  22,
  30
],

},
},'admin-2-boundary'); // Place polygon under these labels.

map.addLayer({
"id": "🛠 ППТ",
"type": "fill",
"source": {
type: 'vector',
url: 'mapbox://yanpogutsa.67zh48hu'
},
"source-layer": "PPT-WIP-1movuq",
"layout": {
"visibility": "none",
},
"paint": {
"fill-color": "hsla(224, 32%, 51%, 0.2)",
"fill-outline-color": "hsla(224, 32%, 51%, 0.5)"
},
},'admin-2-boundary'); // Place polygon under these labels.
map.addLayer({
"id": "ППТ",
"type": "fill",
"source": {
type: 'vector',
url: 'mapbox://yanpogutsa.56ogmwov'
},
"source-layer": "PPT-122uv6",
"layout": {
"visibility": "none",
},
"paint": {
"fill-color": "hsla(0, 100%, 33%, 0.2)",
"fill-outline-color": "hsla(0, 100%, 33%, 0.5)"
},
},'admin-2-boundary'); // Place polygon under these labels.
///////////////////////////////////////////////
map.addLayer({
id: '🗺',
source: {'type': 'raster',
        'tiles': ['https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'],
        'tileSize': 128,
        'scheme': 'xyz',
    },
type: "raster",
layout: { 'visibility': 'none'},
}, 'moscow-boundary-aghg2c');
// Add the source to query. In this example we're using
// county polygons uploaded as vector tiles
map.addLayer({
"id": "ngpt",
"type": "line",
"source": {
type: 'vector',
url: 'mapbox://yanpogutsa.dp8fgjzc'
},
"source-layer": "routes-3apr3n",
"layout": {
"line-join": "round",
"line-cap": "round"
},
"paint": {
"line-color": "rgba(0,0,0,0.2)",
"line-width":0
},
"minZoom": 10,
}); // Place polygon under these labels.
map.addLayer({
"id": "text-highlighted",
"type": "symbol",
"source": {
type: 'vector',
url: 'mapbox://yanpogutsa.dp8fgjzc'
},
"source-layer": "routes-3apr3n",
"layout": {
"text-field": ["to-string", ["get", "ref"]],
"text-size": 8,
"symbol-placement": "line",
"text-offset": [0, 1],
"text-font": [
  "Ubuntu Mono Regular"
]
},
"paint": {
"text-color": [
  "interpolate",
  ["linear"],
  ["get", "color"],
  1,
  "#006ff7",
  2,
  "#484848",
  3,
  "#ffc33c",
  4,
  "#ff5575"
],
},
"minZoom": 10,
 "filter": ["in", "fid", ""]
}); // Place polygon under these labels.
map.addLayer({
"id": "ngpt-highlighted",
"type": "line",
"source": {
type: 'vector',
url: 'mapbox://yanpogutsa.dp8fgjzc'
},
"source-layer": "routes-3apr3n",
"layout": {
"line-join": "round",
"line-cap": "round",
},
"paint": {
"line-color": [
  "interpolate",
  ["linear"],
  ["get", "color"],
  1,
  "#006ff7",
  2,
  "#484848",
  3,
  "#ffc33c",
  4,
  "#ff5575"
],
"line-width": 1,
"line-dasharray": [3, 1],
"line-gap-width": [
  "interpolate",
  ["linear"],
  ["get", "color"],
  1,
  2,
  4,
  10
]
},
"minZoom": 10,
"filter": ["in", "fid", ""]
},'text-highlighted');
 // Place polygon under these labels.
map.addLayer({
"id": "ngpt-pass-text",
"type": "symbol",
"source": {
type: 'vector',
url: 'mapbox://yanpogutsa.4f2h0yzc'
},
"source-layer": "ngpt-pass-18g3e0",
"layout": {
"visibility": "none",
"icon-ignore-placement": "true",
"text-field": [
  "to-string",
  [
    "get",
    "pass"
  ]
],
"text-size": 8,
"symbol-placement": "point",
"text-offset": [
  "interpolate",
  [
    "cubic-bezier",
    0.3,
    1,
    1,
    1
  ],
  [
    "get",
    "pass"
  ],
  1,
  ["literal", [0, 1]],
  11832,
  ["literal", [0, 8]]
],
"text-font": [
  "Ubuntu Mono Regular"
],
"icon-allow-overlap": true,
"icon-ignore-placement": true,
},
"paint": {
"text-color": "#006ef5",
"text-halo-color":"hsla(0, 0%, 100%, 0.5)",
"text-halo-width": 1.5
},
"minzoom": 13
},);

map.addLayer({
"id": "ngpt-pass",
"type": "circle",
"source": {
type: 'vector',
url: 'mapbox://yanpogutsa.4f2h0yzc'
},
"source-layer": "ngpt-pass-18g3e0",
"layout": {
"visibility": "none",
},
"paint": {
"circle-color": "hsla(213, 100%, 48%, 0.2)",
"circle-radius": [
  "interpolate",
  [
    "cubic-bezier",
    0.3,
    1,
    1,
    1
  ],
  [
    "get",
    "pass"
  ],
  0,
  15,
  11832,
  80
]
},
"minzoom": 13
},'places-5y0blc');
 // Place polygon under these labels.
map.addLayer({
"id": "metro-pass",
"type": "circle",
"source": {
"type": "geojson",
"data": "./data/Metro-load-lite.json"
},
"layout": {
  "visibility": "none"
},
"paint": {
"circle-color": "hsla(4, 86%, 53%, 0.2)",
"circle-radius": [
  "interpolate",
  [
    "cubic-bezier",
    0.3,
    1,
    1,
    1
  ],
  [
    "get",
    "Average"
  ],
  0,
  15,
  90000,
  80
]
},
"minzoom":13
});

map.addLayer({
"id": "metro-pass-text",
"type": "symbol",
"source": {
"type": "geojson",
"data": "./data/Metro-load-lite.json"
},
"layout": {
  "visibility": "none",
"text-field": [
  "to-string",
  [
    "get",
    "Average"
  ]
],
"text-size": 8,
"symbol-placement": "point",
"text-offset": [
  "interpolate",
  [
    "cubic-bezier",
    0.3,
    1,
    1,
    1
  ],
  [
    "get",
    "Average"
  ],
  1,
  ["literal", [0, 1]],
  90000,
  ["literal", [0, 8]]
],
"text-font": [
  "Ubuntu Mono Regular"
],
"icon-allow-overlap": true,
"icon-ignore-placement": true,
},
"paint": {
"text-color": "hsla(4, 86%, 53%, 1)",
"text-halo-color":"hsla(0, 0%, 100%, 0.5)",
"text-halo-width": 1
},
"minzoom": 13
});

});

var toggleableLayerIds = [ '🛠 ППТ','ППТ','ДКР','🗺' ];
 
for (var i = 0; i < toggleableLayerIds.length; i++) {
var id = toggleableLayerIds[i];
 
var link = document.createElement('a');
link.href = '#';
link.className = 'active';
link.textContent = id;
 
link.onclick = function (e) {
var clickedLayer = this.textContent;
e.preventDefault();
e.stopPropagation();
 
var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
 
if (visibility === 'none') {
map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
this.className = '';
} else {
this.className = 'active';
map.setLayoutProperty(clickedLayer, 'visibility', 'none');
}
};
 
var layers = document.getElementById('menu');
layers.appendChild(link);
};

map.on('click', 'metro-stations-close', function (e) {popup.setLngLat(e.lngLat)
.setHTML('<h3>'+e.features[0].properties.NameOfStation+' Вход №'+e.features[0].properties.ref+'</h3>'+'<p>' + e.features[0].properties.line + '</p>')
.addTo(map);
map.setLayoutProperty('metro-pass','visibility','visible');
map.setLayoutProperty('metro-pass-text','visibility','visible');
});

// Change the cursor to a pointer when the mouse is over the places layer.
map.on('mouseenter', 'metro-stations-close', function () {
map.getCanvas().style.cursor = 'pointer';
});
 
// Change it back to a pointer when it leaves.
map.on('mouseleave', 'metro-stations-close', function () {
map.getCanvas().style.cursor = '';
});



map.on('click', 'MCD_stations', function (e) {
new mapboxgl.Popup()
.setLngLat(e.lngLat)
.setHTML('<h3>'+e.features[0].properties.name+'</h3>'+'<p>Пасспоток 2018: ' + e.features[0].properties.Pass2018 + '</p>Пасспоток 2020: ' + e.features[0].properties.Pass2020 + '</p>'+ '</p>Пасспоток 2025: ' + e.features[0].properties.Pass2025 + '</p>')
.addTo(map);
});
// Change the cursor to a pointer when the mouse is over the places layer.
map.on('mouseenter', 'MCD_stations', function () {
map.getCanvas().style.cursor = 'pointer';
});
 
// Change it back to a pointer when it leaves.
map.on('mouseleave', 'MCD_stations', function () {
map.getCanvas().style.cursor = '';
});
var popup = new mapboxgl.Popup()
 
map.on('click', 'places-5y0blc', function (e) { popup.setLngLat(e.lngLat)
.setHTML('<h3>'+e.features[0].properties.StationName+'</h3>'+'<p>Маршруты: ' + e.features[0].properties.RouteNumbers + '</p>')
.addTo(map);});
// Change the cursor to a pointer when the mouse is over the places layer.
map.on('mouseenter', 'places-5y0blc', function () {
map.getCanvas().style.cursor = 'pointer';
});
// Change it back to a pointer when it leaves.
map.on('mouseleave', 'places-5y0blc', function () {
map.getCanvas().style.cursor = '';
});
map.on('click', 'places-5y0blc', function(e) {
// set bbox as 5px reactangle area around clicked point
var bbox = [[e.point.x - 20, e.point.y - 20], [e.point.x + 20, e.point.y + 20]];
var features = map.queryRenderedFeatures(bbox, { layers: ['ngpt'] });
 
// Run through the selected features and set a filter
// to match features with unique FIPS codes to activate
// the `counties-highlighted` layer.
var filter = features.reduce(function(memo, feature) {
memo.push(feature.properties.fid);
return memo;
}, ['in', 'fid']);
 
map.setFilter("ngpt-highlighted", filter);
map.setFilter("text-highlighted", filter);
map.setPaintProperty('metro-lines','line-color','#444');
map.setPaintProperty('metro-lines-constructing','line-color','#444');
map.setPaintProperty('MCC','line-color','#444');
map.setPaintProperty('MCD-lines','line-color','#444');
map.setLayoutProperty('ngpt-pass','visibility','visible');
map.setLayoutProperty('ngpt-pass-text','visibility','visible');
});
//map.on('click', 'ngpt-highlighted', function(e) {
// set bbox as 5px reactangle area around clicked point
popup.on('close', function(e) {
map.setFilter("ngpt-highlighted", ["in", "fid", ""]);
map.setFilter("text-highlighted", ["in", "fid", ""]);
map.setPaintProperty('metro-lines','line-color',["get", "colour"]);
map.setPaintProperty('metro-lines-constructing','line-color',["get", "colour"]);
map.setPaintProperty('MCC','line-color','#ef1f26');
map.setPaintProperty('MCD-lines','line-color',[
  "interpolate",
  ["linear"],
  ["get", "MCD"],
  1,
  "hsl(37, 97%, 55%)",
  2,
  "hsl(338, 84%, 62%)",
  3,
  "hsl(19, 88%, 54%)",
  4,
  "hsl(158, 53%, 48%)",
  5,
  "hsl(98, 49%, 51%)"
]);
map.setLayoutProperty('ngpt-pass','visibility','none');
map.setLayoutProperty('ngpt-pass-text','visibility','none');
map.setLayoutProperty('metro-pass','visibility','none');
map.setLayoutProperty('metro-pass-text','visibility','none');
map.setPaintProperty('🛠 ППТ','fill-color','hsla(224, 32%, 51%, 0.2)');
map.setPaintProperty('ППТ','fill-color','hsla(0, 100%, 33%, 0.2)');
map.setFilter("🛠 ППТ", undefined); //["in", "REG_NUM", ""]);
map.setFilter("ППТ", undefined); //["in", "REG_NUM", ""]);
});
///////////////////////////
map.on('click', '🛠 ППТ', function (e) { popup.setLngLat(e.lngLat)
.setHTML('<h3>'+e.features[0].properties.NAME+'</h3>'+'<p>Вид ППТ: ' + e.features[0].properties.VID_PPT + '</p>'+'<p>Дата начала разработки: ' + e.features[0].properties.DATA_DOC_RAZR + '</p>'+'<p>Исполнитель: ' + e.features[0].properties.ISPOLNITEL + '</p>')
.addTo(map);
var feature = e.features[0];
map.setFilter("🛠 ППТ", ['in','REG_NUM', feature.properties.REG_NUM]);
map.setPaintProperty('🛠 ППТ','fill-color','hsla(224, 32%, 51%, 0.7)');
});
// Change the cursor to a pointer when the mouse is over the places layer.
map.on('mouseenter', '🛠 ППТ', function () {
map.getCanvas().style.cursor = 'pointer';
});
// Change it back to a pointer when it leaves.
map.on('mouseleave', '🛠 ППТ', function () {
map.getCanvas().style.cursor = '';
});
map.on('click', 'ППТ', function (e) { popup.setLngLat(e.lngLat)
.setHTML('<h3>'+e.features[0].properties.NAME+'</h3>'+'<p>Вид ППТ: ' + e.features[0].properties.VID_PPT + '</p>'+'<p>Дата утверждения: ' + e.features[0].properties.DATA_DOC_UTV + '</p>'+'<p>Исполнитель: ' + e.features[0].properties.ISPOLNITEL + '</p>')
.addTo(map);
var feature = e.features[0];
map.setFilter("ППТ", ['in','REG_NUM', feature.properties.REG_NUM]);
map.setPaintProperty('ППТ','fill-color','hsla(0, 100%, 33%, 0.7)');
});
// Change the cursor to a pointer when the mouse is over the places layer.
map.on('mouseenter', 'ППТ', function () {
map.getCanvas().style.cursor = 'pointer';
});
// Change it back to a pointer when it leaves.
map.on('mouseleave', 'ППТ', function () {
map.getCanvas().style.cursor = '';
});

map.on('click', 'ДКР', function (e) { popup.setLngLat(e.lngLat)
.setHTML('<h3>'+e.features[0].properties.Year+' | '+e.features[0].properties.Name+'</h3>')
.addTo(map);
});

map.on('click', 'bridges-1aqn6e', function (e) { popup.setLngLat(e.lngLat)
.setHTML('<h3>'+e.features[0].properties.status+'</h3>')
.addTo(map);
});

// Change the cursor to a pointer when the mouse is over the places layer.
map.on('mouseenter', 'ДКР', function () {
map.getCanvas().style.cursor = 'pointer';
});
// Change it back to a pointer when it leaves.
map.on('mouseleave', 'ДКР', function () {
map.getCanvas().style.cursor = '';
});

var geocoder = new MapboxGeocoder({
accessToken: mapboxgl.accessToken,
mapboxgl: mapboxgl,
placeholder: "Поиск",

bbox: [36.5401693241436050, 55.0203058196276160, 38.3135420226066969, 56.1505434064830737],
});
 
document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

map.on('dblclick',function windowOpen(e) { 
  var url1='https://www.google.com/maps/@?api=1&map_action=pano&pano=tu510ie_z4ptBZYo2BGEJg&viewpoint='+e.lngLat.lat+','+e.lngLat.lng+'&heading=0&pitch=10&fov=250';
            Window = window.open( 
              url1, 
                "_blank"); 
        });

map.on('mousemove', function (e) {
  if (map.getPitch() > 0) 
    map.setLayoutProperty('3d-buildings','visibility','visible'),
    map.setLayoutProperty('buildings-13ut9s','visibility','none');  
  else 
    map.setLayoutProperty('3d-buildings','visibility','none'),
    map.setLayoutProperty('buildings-13ut9s','visibility','visible');
  }
);

this.map.on('touchstart', function(data) {
   if (data.points.length == 2) {
      var diff = Math.abs(data.points[0].y - data.points[1].y);
      if (diff <= 50) {
         data.originalEvent.preventDefault();   //prevent browser refresh on pull down
         self.map.touchZoomRotate.disable();    //disable native touch controls
         self.map.dragPan.disable();
         self.dpPoint = data.point;
         self.dpPitch = self.map.getPitch();
      }
   }
});

map.on('touchmove', function (e) {
  if (map.getPitch() > 0) 
    map.setLayoutProperty('3d-buildings','visibility','visible'),
    map.setLayoutProperty('buildings-13ut9s','visibility','none');  
  else 
    map.setLayoutProperty('3d-buildings','visibility','none'),
    map.setLayoutProperty('buildings-13ut9s','visibility','visible');
  }
);

this.map.on('touchmove', function(data) {
   if (self.dpPoint) {
      data.preventDefault(); 
      data.originalEvent.preventDefault();
      var diff = (self.dpPoint.y - data.point.y) * 0.5;
      self.map.setPitch(self.dpPitch + diff);
   };
});

this.map.on('touchend', function(data) {
    if (self.dpPoint){
      self.map.touchZoomRotate.enable();
      self.map.dragPan.enable();
   }
   self.dpPoint = null;
});

this.map.on('touchcancel', function(data) {   
   if (self.dpPoint){
      self.map.touchZoomRotate.enable();
      self.map.dragPan.enable();
   }
   self.dpPoint = null;
}); 

</script>
 
</body>
</html>
